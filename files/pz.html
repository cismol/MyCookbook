<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panzerzug - Personalplanung</title>
<link rel="stylesheet" href="pz_css.css">
</head>
<body>
  <div class="container">
    <h1>Panzerzug — automatische Personalplanung</h1>
    <p class="compact">Pflege Personal, wähle Anzahl Panzer (UNO..QUATTRO), Det-Grössen, fixe Einteilungen und erstelle automatisiert Pläne. Daten werden lokal gespeichert.</p>

    <div class="grid">
      <div class="card">
        <h2 style="margin-top:0">Personalverwaltung</h2>
        <label>Name</label>
        <input id="name" type="text" placeholder="Vorname Nachname" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="role">
            <option value="RiLa">RiLa (Richter/Lader)</option>
            <option value="Fhr">Fhr (Fahrer)</option>
            <option value="WM">Wm (Wachtmeister)</option>
            <option value="LT">Lt (Leutnant)</option>
          </select>
          <select id="status">
            <option value="available">Verfügbar</option>
            <option value="wache">Wache</option>
            <option value="kueche">Küche</option>
            <option value="urlaub">Urlaub</option>
            <option value="nichtplanbar">Nicht planbar</option>
          </select>
          <button id="add" class="small">hinzufügen</button>
        </div>

        <div class="list" id="peopleList"></div>

        <div class="controls">
          <button id="saveAll" class="small">Speichern</button>
          <button id="exportBtn" class="small">Export JSON</button>
          <button id="importBtn" class="small">Import</button>
          <input id="importArea" placeholder="JSON hier einfügen" style="flex:1;background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:inherit" />
        </div>

        <p class="footer">Hinweis: Daten werden im Browser (localStorage) gespeichert. Fixe Einteilungen bleiben erhalten und werden bei automatischer Planung priorisiert.</p>
      </div>

      <div class="card">
        <h2 style="margin-top:0">Plan-Einstellungen & Automatik</h2>
        <div class="row">
          <label style="flex:0 0 160px">Anzahl Panzer</label>
          <input id="tankCount" type="number" min="0" max="10" value="2" style="width:80px" />
          <div class="flex" style="margin-left:auto">
            <label class="compact">Aufklärung (Grösse)</label>
            <input id="aufkSize" type="number" min="0" value="1" style="width:70px" />
            <label class="compact">Absperr (Grösse)</label>
            <input id="abssize" type="number" min="0" value="1" style="width:70px" />
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="autoPlan">Automatisch planen</button>
          <button id="clearPlan" class="small">Plan zurücksetzen</button>
          <div style="margin-left:auto">
            <label class="compact">Benutzerdef. Reihenfolge:</label>
            <select id="priority">
              <option value="availableFirst">Verfügbare zuerst</option>
              <option value="fixedFirst">Fixe Einteilungen bevorzugen</option>
            </select>
          </div>
        </div>

        <h3 style="margin-top:12px">Letzter Plan</h3>
        <div id="planArea"></div>

        <h3 style="margin-top:12px">Übersicht Wache / Küche / Urlaub / Nicht planbar</h3>
        <div id="specialAssignments"></div>

        <h3 style="margin-top:12px">Übersicht unzugeteilter / Warnungen</h3>
        <div id="leftovers"></div>
      </div>
    </div>
  </div>
<script>
// --- Datenmodell & Persistenz ---
const STORAGE_KEY = 'pz_personal_v2';
let state = {
  people: [], // {id,name,role,status,fixedTank:null}
  tankCount: 2,
  aufkSize: 1,
  abssize: 1,
  lastPlan: null
};

function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
function loadState(){const raw = localStorage.getItem(STORAGE_KEY); if(raw){try{state=JSON.parse(raw);}catch(e){console.error(e);} }}
loadState();

// --- Helpers ---
function uid(){return Math.random().toString(36).slice(2,9)}

// --- UI Bindings ---
const peopleList = document.getElementById('peopleList');
const nameIn = document.getElementById('name');
const roleIn = document.getElementById('role');
const statusIn = document.getElementById('status');
const addBtn = document.getElementById('add');
const saveBtn = document.getElementById('saveAll');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importArea = document.getElementById('importArea');
const tankCountIn = document.getElementById('tankCount');
const aufkIn = document.getElementById('aufkSize');
const absIn = document.getElementById('abssize');
const autoBtn = document.getElementById('autoPlan');
const planArea = document.getElementById('planArea');
const leftovers = document.getElementById('leftovers');
const clearPlanBtn = document.getElementById('clearPlan');
const prioritySel = document.getElementById('priority');
const specialAssignments = document.getElementById('specialAssignments');

// --- Inputs ---
function refreshInputs(){
  tankCountIn.value = state.tankCount;
  aufkIn.value = state.aufkSize;
  absIn.value = state.abssize;
}

// --- Render Personen ---
function renderPeople(){
  peopleList.innerHTML='';
  if(state.people.length===0){peopleList.innerHTML='<p class="compact">Keine Personen angelegt.</p>';return}
  state.people.forEach(p=>{
    const el = document.createElement('div'); el.className='person';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:600">${p.name}</div><div class="compact">${p.role} • ${p.status}</div>`;
    const right = document.createElement('div');
    right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

    const fixed = document.createElement('select');
    fixed.innerHTML = '<option value="">nicht fix</option>' +
      Array.from({length:state.tankCount},(_,i)=>`<option value="${i+1}">Panzer ${i+1}</option>`).join('') +
      '<option value="aufk">Aufkl.</option><option value="abs">Abspr.</option>';
    fixed.value = p.fixedTank||'';
    fixed.onchange = ()=>{p.fixedTank = fixed.value||null; saveState(); renderPeople()}
    right.appendChild(fixed);

    const del = document.createElement('button'); del.textContent='✕'; del.title='Löschen'; del.onclick=()=>{state.people = state.people.filter(x=>x.id!==p.id); saveState(); renderPeople()}
    right.appendChild(del);

    el.appendChild(left); el.appendChild(right);
    peopleList.appendChild(el);
	
	
  })
}
function renderPeople() {
  peopleList.innerHTML = '';
  if(state.people.length === 0){
    peopleList.innerHTML = '<p class="compact">Keine Personen angelegt.</p>';
    return;
  }

  state.people.forEach(p => {
    const el = document.createElement('div');
    el.className = 'person';

    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:600">${p.name}</div><div class="compact">${p.role} • ${p.status}</div>`;

    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.gap = '8px';
    right.style.alignItems = 'center';

    // --- Status Dropdown ---
    const statusselect = document.createElement('select');
    ['available','wache','kueche','urlaub','nichtplanbar'].forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
      if(s === p.status) opt.selected = true;
      statusselect.appendChild(opt);
    });
    statusselect.onchange = ()=>{
      p.status = statusselect.value;
      saveState();
      renderPeople();
    };
    right.appendChild(statusselect);

    // --- Fixed Tank Auswahl ---
    const fixed = document.createElement('select');
    fixed.innerHTML = '<option value="">nicht fix</option>' +
      Array.from({length:state.tankCount},(_,i)=>`<option value="${i+1}">Panzer ${i+1}</option>`).join('') +
      '<option value="aufk">Aufkl.</option><option value="abs">Abspr.</option>';
    fixed.value = p.fixedTank || '';
    fixed.onchange = ()=>{
      p.fixedTank = fixed.value || null;
      saveState();
      renderPeople();
    };
    right.appendChild(fixed);

    // --- Löschen ---
    const del = document.createElement('button');
    del.textContent = '✕';
    del.title = 'Löschen';
    del.onclick = ()=>{state.people = state.people.filter(x => x.id !== p.id); saveState(); renderPeople();}
    right.appendChild(del);

    el.appendChild(left);
    el.appendChild(right);
    peopleList.appendChild(el);
  });
}


// --- Personen hinzufügen ---
addBtn.onclick = ()=>{
  const name = nameIn.value.trim(); if(!name) return alert('Bitte Namen eingeben');
  const role = roleIn.value; const status = statusIn.value;
  state.people.push({id:uid(),name,role,status,fixedTank:null});
  nameIn.value=''; saveState(); renderPeople();
}

// --- Speicher & Import/Export ---
saveBtn.onclick = ()=>{state.tankCount = Number(tankCountIn.value); state.aufkSize = Number(aufkIn.value); state.abssize = Number(absIn.value); saveState(); alert('Gespeichert')}
exportBtn.onclick = ()=>{const data = JSON.stringify(state,null,2); importArea.value = data; alert('JSON im Feld unten eingefügt. Kopiere zum Export.')}
importBtn.onclick = ()=>{try{const parsed = JSON.parse(importArea.value); state = parsed; saveState(); refreshInputs(); renderPeople(); renderPlan(state.lastPlan); alert('Import erfolgreich')}catch(e){alert('Ungültiges JSON') }}

tankCountIn.onchange = ()=>{state.tankCount = Number(tankCountIn.value); saveState(); renderPeople()}
aufkIn.onchange = ()=>{state.aufkSize = Number(aufkIn.value); saveState()}
absIn.onchange = ()=>{state.abssize = Number(absIn.value); saveState()}

clearPlanBtn.onclick = ()=>{state.lastPlan=null; saveState(); renderPlan(null); leftovers.innerHTML=''; specialAssignments.innerHTML='';}

// --- Planung ---
function createEmptyPlan(tankCount){
  const tanks = [];
  const names = ['UNO','DUE','TRE','QUATTRO'];
  for(let i=0;i<tankCount;i++){
    const tname = names[i]||('P'+(i+1));
    const slots = [];
    if(i===0){ // UNO
      slots.push({role:'LT',assigned:null});
      slots.push({role:'RiLa',assigned:null});
      slots.push({role:'RiLa',assigned:null});
      slots.push({role:'Fhr',assigned:null});
    } else {
      slots.push({role:'WM',assigned:null});
      slots.push({role:'RiLa',assigned:null});
      slots.push({role:'RiLa',assigned:null});
      slots.push({role:'Fhr',assigned:null});
    }
    tanks.push({name:tname,slots});
  }
  return {tanks,aufk:[],abs:[]}
}

// --- Automatische Planung ---
function autoPlan(){
  const plan = createEmptyPlan(state.tankCount);

  const availableForTanks = state.people.filter(p=>p.status==='available');
  const poolByRole = {RiLa:[],Fhr:[],WM:[],LT:[]};
  availableForTanks.forEach(p=>{ if(p.role in poolByRole) poolByRole[p.role].push(p); });

  // --- Fixe Einteilungen ---
  state.people.forEach(p=>{
    if(!p.fixedTank || p.status!=='available') return;
    if(p.fixedTank==='aufk'){ if(plan.aufk.length < state.aufkSize) plan.aufk.push(p); }
    else if(p.fixedTank==='abs'){ if(plan.abs.length < state.abssize) plan.abs.push(p); }
    else{
      const idx = Number(p.fixedTank)-1; if(idx>=0 && idx<plan.tanks.length){
        const slot = plan.tanks[idx].slots.find(s=>s.role===p.role && !s.assigned);
        if(slot) slot.assigned = p;
      }
    }
  });

  // --- Tanks füllen ---
  function takeFromPool(role){
    if(poolByRole[role] && poolByRole[role].length>0) return poolByRole[role].shift();
    if(role==='WM' && poolByRole['LT'] && poolByRole['LT'].length>0) return poolByRole['LT'].shift();
    return null;
  }

  plan.tanks.forEach(tank=>{
    tank.slots.forEach(slot=>{
      if(!slot.assigned){
        const p = takeFromPool(slot.role);
        if(p) slot.assigned = p;
      }
    });
  });

  // --- Dets füllen ---
  const remaining = state.people.filter(p=>!plan.tanks.some(t=>t.slots.some(s=>s.assigned && s.assigned.id===p.id)));
  remaining.forEach(p=>{
    if(p.fixedTank==='aufk' && plan.aufk.length<state.aufkSize) plan.aufk.push(p);
    else if(p.fixedTank==='abs' && plan.abs.length<state.abssize) plan.abs.push(p);
  });

  // Restliche verfügbare auf Dets verteilen
  const stillRemaining = remaining.filter(p=>p.status==='available');
  for(let i=plan.aufk.length;i<state.aufkSize;i++){ const p = stillRemaining.shift(); if(!p) break; plan.aufk.push(p);}
  for(let i=plan.abs.length;i<state.abssize;i++){ const p = stillRemaining.shift(); if(!p) break; plan.abs.push(p);}

  state.lastPlan = plan; saveState();
  renderPlan(plan);
  renderLeftovers(stillRemaining);
  renderSpecialAssignments();
}

// --- Render Plan ---
function renderPlan(plan){
  planArea.innerHTML='';
  if(!plan){ planArea.innerHTML='<p class="compact">Kein Plan vorhanden.</p>'; return }
  const wrapper = document.createElement('div'); wrapper.className='plan';
  plan.tanks.forEach(t=>{
    const box = document.createElement('div'); box.className='tank card';
    box.innerHTML = `<h3>${t.name}</h3>`;
    t.slots.forEach(s=>{
      const div = document.createElement('div'); div.className='slot';
      div.innerHTML = `<div>${s.role}</div><div>${s.assigned? `<strong>${s.assigned.name}</strong>`:'<span class="warn">frei</span>'}</div>`;
      box.appendChild(div);
    })
    wrapper.appendChild(box);
  });
  const dbox = document.createElement('div'); dbox.className='tank card';
  dbox.innerHTML = '<h3>Aufklärung</h3>' + (plan.aufk.map(p=>`<div class="slot"><div>Mitglied</div><div><strong>${p.name}</strong></div></div>`).join('') || '<div class="compact warn">leer</div>');
  wrapper.appendChild(dbox);
  const abox = document.createElement('div'); abox.className='tank card';
  abox.innerHTML = '<h3>Absperr</h3>' + (plan.abs.map(p=>`<div class="slot"><div>Mitglied</div><div><strong>${p.name}</strong></div></div>`).join('') || '<div class="compact warn">leer</div>');
  wrapper.appendChild(abox);
  planArea.appendChild(wrapper);
}

// --- Render Leftovers ---
function renderLeftovers(arr){
  leftovers.innerHTML='';
  if(arr.length===0){ leftovers.innerHTML='<div class="success">Alle Personen zugeteilt.</div>'; return }
  arr.forEach(p=>{
    const el = document.createElement('div'); el.className='person';
    el.innerHTML = `<div><strong>${p.name}</strong><div class="compact">${p.role} • ${p.status} ${p.fixedTank? '• fix:'+p.fixedTank:''}</div></div><div class="badge">frei</div>`;
    leftovers.appendChild(el);
  })
}

// --- Render Special Assignments ---
function renderSpecialAssignments(){
  specialAssignments.innerHTML='';
  const groups = {Wache:[],Küche:[],Urlaub:[],NichtPlanbar:[]};
  state.people.forEach(p=>{
    if(p.status==='wache') groups.Wache.push(p);
    else if(p.status==='kueche') groups.Küche.push(p);
    else if(p.status==='urlaub') groups.Urlaub.push(p);
    else if(p.status==='nichtplanbar') groups.NichtPlanbar.push(p);
  });
  for(const [name,arr] of Object.entries(groups)){
    const div = document.createElement('div');
    div.innerHTML = `<div class="group-title">${name}</div>` + (arr.map(p=>`<div class="slot"><div>${p.role}</div><div><strong>${p.name}</strong></div></div>`).join('') || '<div class="compact warn">leer</div>');
    specialAssignments.appendChild(div);
  }
}

// --- Init ---
refreshInputs(); renderPeople(); renderPlan(state.lastPlan);

autoBtn.onclick = ()=>{autoPlan()};
</script>
</body>
</html>
