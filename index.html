<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Recipe Book</title>
    <link rel="stylesheet" type="text/css" href="style/style.css">
</head>
<body>
<header>
    <h1>My Cookbook</h1>
    <div class="search-bar">
        <input type="text" id="searchInput" class="search-input" placeholder="Search recipes...">
        <button id="searchButton">Search</button>
    </div>
    <nav>
        <a href="#">Home</a>
        <a href="#">Recipes</a>
        <a href="#">About</a>
        <a href="#">Contact</a>
    </nav>
</header>


<div id="recipeList"></div>

<div class="edit-form" id="editForm" style="display: none;">
    <h2>Edit Recipe</h2>
    <input type="text" id="editRecipeTitle" placeholder="Title">
    <textarea id="editRecipeDescription" placeholder="Description"></textarea>
    <button id="saveEditButton">Save Changes</button>
</div>

<div class="upload-form">
    <h2>Add New Recipe</h2>
    <input type="text" id="newRecipeTitle" placeholder="Title">
	<!-- Inside the upload-form div, add after the description textarea -->
	<div id="ingredientsList">
		<h3>Ingredients</h3>
		<div class="ingredient" id="ingredientTemplate">
			<input type="text" placeholder="Menge" class="ingredient-quantity">
			<input type="text" placeholder="Zutat" class="ingredient-name">
			<button class="removeIngredient">Remove</button>
		</div>
	</div>
	<button type="button" id="addIngredientButton">Add Ingredient</button>
    <textarea id="newRecipeDescription" placeholder="Description"></textarea>
     <!--<input type="file" id="newRecipeImage" accept="image/*">-->
    <button id="uploadRecipeButton">Upload Recipe</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    // Import Firebase Storage module
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyDxvabrO3eNRTm37fE7G7sxckZBJrrnpHQ",
        authDomain: "mycookbook-ee7d2.firebaseapp.com",
        projectId: "mycookbook-ee7d2",
        storageBucket: "mycookbook-ee7d2.appspot.com",
        messagingSenderId: "49507480622",
        appId: "1:49507480622:web:679369b3d9568dc15adbbf",
        measurementId: "G-1MXN7NP98K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app); // Initialize Firebase Storage

    document.getElementById('uploadRecipeButton').addEventListener('click', addRecipe);
    document.getElementById('searchButton').addEventListener('click', () => fetchRecipes(document.getElementById('searchInput').value.trim()));


    async function showEditForm(docId) {
        const docRef = doc(db, "recipes", docId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const recipeData = docSnap.data();
            document.getElementById('editRecipeTitle').value = recipeData.title;
            document.getElementById('editRecipeDescription').value = recipeData.description;
            
            // Clear existing ingredient inputs except the template
            document.querySelectorAll('.ingredient:not(#ingredientTemplate)').forEach(el => el.remove());

            // Populate the form with existing ingredients
            recipeData.ingredients.forEach((ingredient, index) => {
                addIngredientField(ingredient); // Pass ingredient data to populate fields
            });

            // Show the form
            const editForm = document.getElementById('editForm');
            editForm.style.display = 'block';
            document.getElementById('saveEditButton').setAttribute('data-id', docId);

            // Ensure at least one ingredient field is available
            if (recipeData.ingredients.length === 0) {
                addIngredientField(); // Add an empty ingredient field if none exist
            }
        } else {
            console.log("No such document!");
        }
    }


	
	document.getElementById('addIngredientButton').addEventListener('click', addIngredientField);
document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('removeIngredient') && ingredientsNodes.length > 0) {
        e.target.parentNode.remove();
        }
});

document.addEventListener('DOMContentLoaded', () => {
    // Initialize the first ingredient field on page load
    addIngredientField();
    document.getElementById('addIngredientButton').addEventListener('click', addIngredientField);
    document.getElementById('uploadRecipeButton').addEventListener('click', addRecipe);
    // Additional initialization code as needed
});

function addIngredientField() {
    const ingredientsList = document.getElementById('ingredientsList');
    const newIngredient = document.getElementById('ingredientTemplate').cloneNode(true);
    newIngredient.style.display = 'flex'; // Make it visible
    // Ensure the cloned node is not the template anymore
    newIngredient.classList.remove('ingredient-template');
    newIngredient.id = '';
    ingredientsList.appendChild(newIngredient);
}

async function addRecipe() {
    const title = document.getElementById('newRecipeTitle').value.trim();
    const description = document.getElementById('newRecipeDescription').value.trim();
    // Exclude the template from the query selector
    const ingredientsNodes = document.querySelectorAll('.ingredient:not(.ingredient-template)');
    const ingredients = Array.from(ingredientsNodes).map(node => ({
        menge: node.querySelector('.ingredient-quantity').value,
        zutat: node.querySelector('.ingredient-name').value
    })).filter(ingredient => ingredient.menge && ingredient.zutat);

    if (title && description && ingredients.length > 0) {
        try {
            await addDoc(collection(db, "recipes"), { title, description, ingredients });
            alert('Recipe added successfully!');
            // Reset form and ingredients list after successful addition
            document.getElementById('newRecipeTitle').value = '';
            document.getElementById('newRecipeDescription').value = '';
            resetIngredientsList(); // Reset the ingredients list
        } catch (error) {
            console.error("Error adding recipe: ", error);
            alert('Failed to add recipe.');
        }
    } else {
        alert('Title, description, and at least one ingredient are required.');
    }
	// Reload the current page
	location.reload();

}

function resetIngredientsList() {
    // Clear existing ingredients
    document.querySelectorAll('.ingredient:not(#ingredientTemplate)').forEach(el => el.remove());
    // Add a new ingredient field for the next recipe
    addIngredientField();
}

document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('removeIngredient')) {
        // Get all the ingredient nodes excluding the template
        const ingredientsNodes = document.querySelectorAll('.ingredient:not(#ingredientTemplate)');
        
        // Only allow removal if there are more than one ingredient elements
        if (ingredientsNodes.length > 0) {
            e.target.parentNode.remove();
        } else {
            alert('You must have at least one ingredient. 2');
			addIngredientField();
        }
    }
});



  async function deleteRecipe(docId) {
        if (confirm('Are you sure you want to delete this recipe?')) {
            await deleteDoc(doc(db, "recipes", docId));
            alert('Recipe deleted successfully.');
            fetchRecipes(); // Refresh the list after deletion
        }
    }


async function fetchRecipes(searchTerm = "") {
    const recipesCollectionRef = collection(db, 'recipes');
    const snapshot = await getDocs(recipesCollectionRef);
    const recipesContainer = document.getElementById('recipeList');
    recipesContainer.innerHTML = '';
    
    snapshot.forEach(doc => {
        const recipe = doc.data();
        if (!searchTerm || recipe.title.toLowerCase().includes(searchTerm.toLowerCase())) {
            const recipeElement = document.createElement('div');
            recipeElement.classList.add('recipe');
			
                			
            let ingredientsHtml = '<ul>';
            if (recipe.ingredients) {
                recipe.ingredients.forEach(ingredient => {
                    ingredientsHtml += `<li>${ingredient.menge} - ${ingredient.zutat}</li>`;
                });
            }
            ingredientsHtml += '</ul>';
            recipeElement.innerHTML = `
                <img src="${recipe.imageUrl || ''}" alt="Recipe image" style="max-width: 100%; height: auto;">
                <h2>${recipe.title}</h2>
                ${ingredientsHtml}
                <p>${recipe.description}</p>
				<!-- TODO: Correctly implement edit -->
               <!-- <button class="editButton" data-id="${doc.id}">Edit</button> --> 
            `;
			
				const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteRecipe(doc.id);
                recipeElement.appendChild(deleteButton);

				recipesContainer.appendChild(recipeElement);
        }
    });

    document.querySelectorAll('.editButton').forEach(button => {
        button.addEventListener('click', function() {
            showEditForm(this.getAttribute('data-id'));
        });
    });
}


    fetchRecipes();
</script>

</body>
</html>
